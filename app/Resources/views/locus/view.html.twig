{% extends 'base.html.twig' %}

{% block title %}
    {{ locus.name }} - {{ locus.chromosome.strain.species.scientificname }} ({{ locus.chromosome.strain.name }}) - {{ parent() }}
{% endblock %}

{% block breadcrumb %}
    {{ parent() }}
    <li class="breadcrumb-item"><a href="{{ path('strain_index') }}">Species & strains list</a></li>
    <li class="breadcrumb-item"><a href="{{ path('species_view', { 'species_slug': locus.chromosome.strain.species.slug }) }}"><i>{{ locus.chromosome.strain.species.scientificname }}</i></a></li>
    <li class="breadcrumb-item"><a href="{{ path('strain_view', { 'species_slug': locus.chromosome.strain.species.slug, 'strain_slug': locus.chromosome.strain.slug }) }}">{{ locus.chromosome.strain.name }}</a></li>
    <li class="breadcrumb-item"><a href="{{ path('chromosome_view', { 'species_slug': locus.chromosome.strain.species.slug, 'strain_slug': locus.chromosome.strain.slug, 'chromosome_slug': locus.chromosome.slug }) }}">{{ locus.chromosome.name }}</a></li>
    <li class="breadcrumb-item active">{{ locus.name }}</li>
{% endblock %}

{% block body %}
    <div class="row">
        <div class="col-9">
            <h1>{{ locus.name }} - <i>{{ locus.chromosome.strain.species.scientificName }}</i> ({{ locus.chromosome.strain.name }})</h1>
        </div>

        <div class="col-3 text-right d-print-none">
            <a class="btn btn-secondary btn-sm cart-add-btn" href="{{ path('cart_add', { 'id': locus.id }) }}" role="button">
                <span class="fas fa-shopping-cart" aria-hidden="true"></span> Add to cart
            </a>

            <button class="btn btn-secondary btn-sm" onClick="window.print()">
                <span class="fas fa-print" aria-hidden="true"></span> Print
            </button>
        </div>
    </div>

    <div class="row justify-content-between d-print-none my-3" aria-label="Previous and next locus">
        <div class="col-4">
            {% if locus.previousLocus %}
                <a class="btn btn-primary" href="{{ path('locus_view', { 'species_slug': locus.chromosome.strain.species.slug, 'strain_slug': locus.chromosome.strain.slug, 'chromosome_slug': locus.chromosome.slug, 'locus_name': locus.previousLocus }) }}"
                data-toggle="tooltip" data-placement="bottom" title="Intergene: {{ locus.previousLocusDistance >= 0 ? locus.previousLocusDistance ~ ' nuc.' : 'overlapping' }}"
                role="button">
                    <span class="fas fa-arrow-left" aria-hidden="true"></span>
                    <span class="d-none d-sm-inline">{{ locus.previousLocus }}</span>
                    <span class="d-sm-none">Previous locus</span>
                </a>
            {% else %}
                <a class="btn btn-primary disabled" href="#" role="button"><span class="fas fa-arrow-left" aria-hidden="true"></span> No previous locus</a>
            {% endif %}
        </div>

        <div class="col-4 text-right">
            {% if locus.nextLocus %}
                <a class="btn btn-primary" href="{{ path('locus_view', { 'species_slug': locus.chromosome.strain.species.slug, 'strain_slug': locus.chromosome.strain.slug, 'chromosome_slug': locus.chromosome.slug, 'locus_name': locus.nextLocus }) }}"
                data-toggle="tooltip" data-placement="bottom" title="Intergene: {{ locus.nextLocusDistance >= 0 ? locus.nextLocusDistance ~ ' nuc.' : 'overlapping' }}"
                role="button">
                    <span class="d-none d-sm-inline">{{ locus.nextLocus }}</span>
                    <span class="d-sm-none">Next locus</span>
                    <span class="fas fa-arrow-right" aria-hidden="true"></span>
                </a>
            {% else %}
                <a class="btn btn-primary disabled" href="#"  role="button">No next locus <span class="fas fa-arrow-right" aria-hidden="true"></span></a>
            {% endif %}
        </div>
    </div>

    <h2>Description</h2>
    <p class="text-justify">
        {{ locus.note }}
    </p>

    <div class="card mb-3">
        <div class="card-header">
            Annotation
        </div>
        <table class="table table-responsive-md table-sm">
            {% for key, annotation in locus.annotation %}
                <tr>
                    <td><b>{{ key }}</b></td>
                    <td>{{ annotation[0] }}</td>
                </tr>
            {% endfor %}
        </table>
    </div>

    <div class="card mb-3">
        <div class="card-header">
            Summary
        </div>

        <table class="table table-responsive-md table-sm">
            <tr>
                <td><b>Species</b></td>
                <td>
                    <a href="{{ path('species_view', { 'species_slug': locus.chromosome.strain.species.slug }) }}">
                        <i>{{ locus.chromosome.strain.species.scientificName }}</i>
                    </a>
                </td>
                <td><b>Positions</b></td>
                <td>{{ locus.start }}..{{ locus.end }}</td>
            </tr>
            <tr>
                <td><b>Strain</b></td>
                <td>
                    <a href="{{ path('strain_view', {
                        'species_slug': locus.chromosome.strain.species.slug,
                        'strain_slug': locus.chromosome.strain.slug }) }}">
                        {{ locus.chromosome.strain.name }}
                    </a>
                </td>
                <td><b>Strand</b></td>
                <td>{{ 1 == locus.strand ? 'Sense' : 'Antisense' }}</td>
            </tr>
            <tr>
                <td><b>Chromosome</b></td>
                <td>
                    <a href="{{ path('chromosome_view', {
                        'species_slug': locus.chromosome.strain.species.slug,
                        'strain_slug': locus.chromosome.strain.slug,
                        'chromosome_slug': locus.chromosome.slug }) }}">
                        {{ locus.chromosome.name }}
                    </a>
                </td>
                <td><b>Total length</b></td>
                <td>{{ locus.end - locus.start + 1 }} (nuc.)</td>
            </tr>
            <tr>
                <td><b>Product number</b></td>
                <td>{{ locus.countProductNumber }}</td>
            </tr>
        </table>
    </div>

    <hr>

    <h2 class="mb-3">Sequence(s)</h2>
    {% for feature in locus.features %}
        <div class="locus-feature" id="locus-feature-{{ loop.index }}" data-feature="{{ feature.name }}">
            <h3>{{ feature.name }}</h3>
            <div class="row">
                <div class="col-lg-9 fasta fasta-nuc">
                    <span class="header">>{{ feature.name }}</span>
                    {% for line in sequences[feature.name] %}
                        {{ line|raw }}<br>
                    {% endfor %}
                </div>

                <hr class="d-md-none">

                <div class="col-lg-3 d-print-none">
                    <p>Legend:</p>
                    <ul class="fasta-legend">
                        <li class="stream">Upstream/Downstream</li>
                        <li class="utr">UTR</li>
                        <li class="exon">Exon</li>
                        <li class="intron">Intron</li>
                    </ul>

                    <hr>

                    {{ form_start(forms[feature.name]) }}
                    {{ form_rest(forms[feature.name]) }}

                    <button type="reset" class="btn btn-secondary" value="Reset">Reset</button>
                    <button type="submit" class="btn btn-primary">Valid</button>
                    {{ form_end(forms[feature.name]) }}
                </div>
            </div>
        </div>
    {% endfor %}

    <hr>

    <h2 class="mb-3">Product(s)</h2>
    {% for feature in locus.features %}
        {% for product in feature.productsFeatures %}
            <h3>{{ product.name }}</h3>
            <p>
                <b>Product type:</b> protein<br>
                <b>Protein length:</b> {{ product.translation|length }} aa.<br>
                <b>Product:</b> {{ product.product is not empty ? product.product|join(', '): product.note }}<br>
                <b>Annotation:</b>
            </p>
            <ul>
                {% if product.annotation['gene'] is defined %}
                    <li>Gene: {{ product.annotation['gene']|join(', ') }}</li>
                {% endif %}
                {% if product.annotation['EC_number'] is defined %}
                    <li>EC number: {{ product.annotation['EC_number']|join(', ') }}</li>
                {% endif %}
            </ul>
            <div class="fasta">
                <span class="header">>{{ product.name }}</span>
                {{ product.translation|wordwrap(60, "\n")|nl2br }}
            </div>
        {% endfor %}
    {% endfor %}

    <hr>

    <h2>References</h2>
    <div class="row">
        {% if is_granted('ROLE_REFERENCER') %}
            <div class="col-12 text-right">

                <a class="btn btn-primary btn-sm" href="{{ path('reference_add_locus', {
                    'name': locus.name,
                }) }}">
                    <span class="fas fa-plus"></span> Add a reference
                </a>
            </div>
        {% endif %}

        <div class="col-12">
            {% if locus.references is not empty %}
                <ul>
                    {% for reference in locus.references %}
                        <li>
                            <a href="{{ reference.url }}" rel="nofollow">
                                {{ reference.authors.0.family }} {{ reference.authors.0.given|slice(0,1) }}
                                {% if reference.authors|length == 2 %}
                                    [and {{ reference.authors.1.family }} {{ reference.authors.1.given|slice(0,1) }}]
                                {% else %}
                                    et al.
                                {% endif %}
                                <i>{{ reference.container }}</i> ({{ reference.issued }})
                            </a>
                            {% if is_granted('ROLE_REFERENCER') %}
                                <a class="btn btn-danger btn-sm" href="{{ path('reference_delete_locus', {'reference_id': reference.id, 'locus_id': locus.id, 'token': csrf_token('reference_delete')}) }}" data-confirmation="1">
                                    <span class="fas fa-trash-alt"></span>
                                </a>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                There is not reference.
            {% endif %}
        </div>
        {% include '_delete_confirmation.html.twig' %}
    </div>
{% endblock %}
