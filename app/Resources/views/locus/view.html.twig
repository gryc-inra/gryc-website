{% extends 'base.html.twig' %}

{% block title %}
    {{ locus.name }} - {{ locus.chromosome.strain.species.scientificname }} ({{ locus.chromosome.strain.name }})
{% endblock %}

{% block breadcrumb %}
    {{ parent() }}
    <li class="breadcrumb-item"><a href="{{ path('strain_index') }}">Species & strains list</a></li>
    <li class="breadcrumb-item"><a href="{{ path('species_view', { 'species_slug': locus.chromosome.strain.species.slug }) }}"><i>{{ locus.chromosome.strain.species.scientificname }}</i></a></li>
    <li class="breadcrumb-item"><a href="{{ path('strain_view', { 'species_slug': locus.chromosome.strain.species.slug, 'strain_slug': locus.chromosome.strain.slug }) }}">{{ locus.chromosome.strain.name }}</a></li>
    <li class="breadcrumb-item"><a href="{{ path('chromosome_view', { 'species_slug': locus.chromosome.strain.species.slug, 'strain_slug': locus.chromosome.strain.slug, 'chromosome_slug': locus.chromosome.slug }) }}">{{ locus.chromosome.name }}</a></li>
    <li class="breadcrumb-item active">{{ locus.name }}</li>
{% endblock %}

{% block body %}
    <div class="row">
        <div class="col-9">
            <h1>{{ locus.name }} - <i>{{ locus.chromosome.strain.species.scientificName }}</i> ({{ locus.chromosome.strain.name }})</h1>
        </div>

        <div class="col-3 text-right d-print-none">
            <a class="btn btn-secondary btn-sm cart-add-btn" href="{{ path('cart_add', { 'id': locus.id }) }}" role="button">
                <span class="fa fa-shopping-cart" aria-hidden="true"></span> Add to cart
            </a>

            <button class="btn btn-secondary btn-sm" onClick="window.print()">
                <span class="fa fa-print" aria-hidden="true"></span> Print
            </button>
        </div>
    </div>

    <div class="row justify-content-between d-print-none my-3" aria-label="Previous and next locus">
        <div class="col-4">
            {% if locus.previousLocus %}
                <a class="btn btn-primary" href="{{ path('locus_view', { 'species_slug': locus.chromosome.strain.species.slug, 'strain_slug': locus.chromosome.strain.slug, 'chromosome_slug': locus.chromosome.slug, 'locus_name': locus.previousLocus }) }}"
                data-toggle="tooltip" data-placement="bottom" title="Intergene: {{ locus.previousLocusDistance >= 0 ? locus.previousLocusDistance ~ ' nuc.' : 'overlapping' }}"
                role="button">
                    <span class="fa fa-arrow-left" aria-hidden="true"></span>
                    <span class="d-none d-sm-inline">{{ locus.previousLocus }}</span>
                    <span class="d-sm-none">Previous locus</span>
                </a>
            {% else %}
                <a class="btn btn-primary disabled" href="#" role="button"><span class="fa fa-arrow-left" aria-hidden="true"></span> No previous locus</a>
            {% endif %}
        </div>

        <div class="col-4 text-right">
            {% if locus.nextLocus %}
                <a class="btn btn-primary" href="{{ path('locus_view', { 'species_slug': locus.chromosome.strain.species.slug, 'strain_slug': locus.chromosome.strain.slug, 'chromosome_slug': locus.chromosome.slug, 'locus_name': locus.nextLocus }) }}"
                data-toggle="tooltip" data-placement="bottom" title="Intergene: {{ locus.nextLocusDistance >= 0 ? locus.nextLocusDistance ~ ' nuc.' : 'overlapping' }}"
                role="button">
                    <span class="d-none d-sm-inline">{{ locus.nextLocus }}</span>
                    <span class="d-sm-none">Next locus</span>
                    <span class="fa fa-arrow-right" aria-hidden="true"></span>
                </a>
            {% else %}
                <a class="btn btn-primary disabled" href="#"  role="button">No next locus <span class="fa fa-arrow-right" aria-hidden="true"></span></a>
            {% endif %}
        </div>
    </div>

    <h2>Description</h2>
    <p class="text-justify">
        {{ locus.note|capitalize }}
    </p>

    <div class="card mb-3">
        <div class="card-header">
            Annotation
        </div>
        <table class="table">
            {% for key, annotation in locus.annotation %}
                <tr>
                    <td><b>{{ key }}</b></td>
                    <td>{{ annotation[0] }}</td>
                </tr>
            {% endfor %}
        </table>
    </div>

    <div class="card mb-3">
        <div class="card-header">
            Summary
        </div>

        <table class="table table-responsive">
            <tr>
                <td><b>Species</b></td>
                <td>
                    <a href="{{ path('species_view', { 'species_slug': locus.chromosome.strain.species.slug }) }}">
                        <i>{{ locus.chromosome.strain.species.scientificName }}</i>
                    </a>
                </td>
                <td><b>Positions</b></td>
                <td>{{ locus.start }}..{{ locus.end }}</td>
            </tr>
            <tr>
                <td><b>Strain</b></td>
                <td>
                    <a href="{{ path('strain_view', {
                        'species_slug': locus.chromosome.strain.species.slug,
                        'strain_slug': locus.chromosome.strain.slug }) }}">
                        {{ locus.chromosome.strain.name }}
                    </a>
                </td>
                <td><b>Strand</b></td>
                <td>{{ 1 == locus.strand ? 'Sense' : 'Antisense' }}</td>
            </tr>
            <tr>
                <td><b>Chromosome</b></td>
                <td>
                    <a href="{{ path('chromosome_view', {
                        'species_slug': locus.chromosome.strain.species.slug,
                        'strain_slug': locus.chromosome.strain.slug,
                        'chromosome_slug': locus.chromosome.slug }) }}">
                        {{ locus.chromosome.name }}
                    </a>
                </td>
                <td><b>Total length</b></td>
                <td>{{ locus.end - locus.start + 1 }} (nuc.)</td>
            </tr>
            <tr>
                <td><b>Product number</b></td>
                <td>{{ locus.countProductNumber }}</td>
            </tr>
        </table>
    </div>

    <hr>

    <h2 class="mb-3">Sequence(s)</h2>
    {% for feature in locus.features %}
        <div class="locus-feature" id="locus-feature-{{ loop.index }}" data-locus="{{ locus.name }}" data-feature="{{ feature.name }}">
            <h3>{{ feature.name }}</h3>
            <div class="row">
                <div class="col-lg-9 fasta fasta-nuc">
                    <span class="header">>{{ feature.name }}</span>
                    {% for line in feature.sequence %}
                        {{ line|raw }}<br>
                    {% endfor %}
                </div>

                <hr class="d-md-none">

                <div class="col-lg-3">
                    <p>Legend:</p>
                    <ul class="fasta-legend">
                        <li class="stream">Upstream/Downstream</li>
                        <li class="utr">UTR</li>
                        <li class="exon">Exon</li>
                        <li class="intron">Intron</li>
                    </ul>

                    <hr>

                    <form class="d-print-none">
                        <div class="form-group">
                            <label>Upstream</label>
                            <input type="number" class="form-control" name="upstream">
                        </div>
                        <div class="form-group">
                            <label>Downstream</label>
                            <input type="number" class="form-control" name="downstream">
                        </div>
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="showUtr" checked> Show UTR
                            </label>
                        </div>
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="showIntron"checked> Show Intron
                            </label>
                        </div>
                        <button type="reset" class="btn btn-secondary" value="Reset">Reset</button>
                        <button type="submit" class="btn btn-primary">Valid</button>
                    </form>
                </div>
            </div>
        </div>
    {% endfor %}

    <hr>

    <h2 class="mb-3">Product(s)</h2>
    {% for feature in locus.features %}
        {% for product in feature.productsFeatures %}
            <h3>{{ product.name }}</h3>
            <p>
                <b>Product type:</b> protein<br>
                <b>Protein length:</b> {{ product.translation|length }} aa.<br>
                <b>Product:</b> {{ product.product is not empty ? product.product|join(', '): product.note }}<br>
                <b>Annotation:</b>
            <ul>
                {% if product.annotation['gene'] is defined %}
                    <li>Gene: {{ product.annotation['gene']|join(', ') }}</li>
                {% endif %}
                {% if product.annotation['EC_number'] is defined %}
                    <li>EC number: {{ product.annotation['EC_number']|join(', ') }}</li>
                {% endif %}
            </ul>
            </p>
            <div class="fasta">
                <span class="header">>{{ product.name }}</span>
                {{ product.translation|wordwrap(60, "\n")|nl2br }}
            </div>
        {% endfor %}
    {% endfor %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script>
        $(document).ready(function(){
            $(function () {
                $('[data-toggle="tooltip"]').tooltip()
            });

            $('div.locus-feature').each(function(index) {
                var locus = $( this ).data("locus");
                var feature = $( this ).data("feature");
                var sequenceContainer = $( this ).find('div.fasta');
                var form = $( this ).find('form');

                form.removeClass('hidden');

                form.submit(function(event) {
                    event.preventDefault();
                    var upstream = $( this ).parent().find("input[name='upstream']").val();
                    var downstream = $( this ).parent().find("input[name='downstream']").val();
                    var showUtr = $( this ).parent().find("input[name='showUtr']").is(":checked");
                    var showIntron = $( this ).parent().find("input[name='showIntron']").is(":checked");

                    $.ajax({
                        type: 'GET',
                        url: Routing.generate('feature_sequence', { locus_name: locus, feature_name: feature, upstream: upstream, downstream: downstream, showUtr: showUtr, showIntron: showIntron }),
                        dataType: 'html',
                        success: function (html) {
                            sequenceContainer.first().html(html);
                        }
                    });
                });
            });
        });
    </script>
{% endblock %}
